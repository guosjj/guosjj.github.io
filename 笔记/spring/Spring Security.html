<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Spring Security - standP</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="standP"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="standP"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="Spring Security登录认证，是所有系统最常见的功能，并且也是最基础最重要的功能。为了能做好这一块诞生了许多安全框架，比如常见的Shiro,Spring Security等。 本次课程目的是为了和大家分享在实际项目中，如何运用安全框架完成登录认证(Authentication)，和权限授权(Authorization)等功能。"><meta property="og:type" content="blog"><meta property="og:title" content="standP"><meta property="og:url" content="https://guosjj.github.io/"><meta property="og:site_name" content="standP"><meta property="og:description" content="Spring Security登录认证，是所有系统最常见的功能，并且也是最基础最重要的功能。为了能做好这一块诞生了许多安全框架，比如常见的Shiro,Spring Security等。 本次课程目的是为了和大家分享在实际项目中，如何运用安全框架完成登录认证(Authentication)，和权限授权(Authorization)等功能。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/1.png"><meta property="article:published_time" content="2022-06-25T07:52:33.000Z"><meta property="article:modified_time" content="2022-06-25T09:46:39.406Z"><meta property="article:author" content="guosjj"><meta property="article:tag" content="Spring Security"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/1.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://guosjj.github.io/%E7%AC%94%E8%AE%B0/spring/Spring%20Security.html"},"headline":"standP","image":["https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/youlingsha.png"],"datePublished":"2022-06-25T07:52:33.000Z","dateModified":"2022-06-25T09:46:39.406Z","author":{"@type":"Person","name":"Guosj"},"description":"Spring Security登录认证，是所有系统最常见的功能，并且也是最基础最重要的功能。为了能做好这一块诞生了许多安全框架，比如常见的Shiro,Spring Security等。 本次课程目的是为了和大家分享在实际项目中，如何运用安全框架完成登录认证(Authentication)，和权限授权(Authorization)等功能。"}</script><link rel="canonical" href="https://guosjj.github.io/%E7%AC%94%E8%AE%B0/spring/Spring%20Security.html"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/logo.png" alt="standP" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item" href="/friend">友链</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item" href="/self-talking">碎碎念</a><a class="navbar-item" href="/music">音乐</a><a class="navbar-item" href="/media">影音</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Join Gitter" href="https://gitter.im/hexo-theme-amazing/community"><i class="fab fa-gitter"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main"><!--!--><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/youlingsha.png" alt="Spring Security"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2022-06-25  <a class="commentCountImg" href="/%E7%AC%94%E8%AE%B0/spring/Spring%20Security.html#comment-container"><span class="display-none-class">6c46578cda1de10de1eeb86946b6f2d6</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="6c46578cda1de10de1eeb86946b6f2d6">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>1 小时  <i class="fas fa-pencil-alt"> </i>6.9 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Spring Security</h1><div class="content"><h2 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h2><p>登录认证，是所有系统最常见的功能，并且也是最基础最重要的功能。为了能做好这一块诞生了许多安全框架，比如常见的Shiro,Spring Security等。</p>
<p>本次课程目的是为了和大家分享在实际项目中，如何运用安全框架完成<strong>登录认证</strong>(Authentication)，和<strong>权限授权</strong>(Authorization)等功能。</p>
<a id="more"></a>

<h3 id="登录认证的原理"><a href="#登录认证的原理" class="headerlink" title="登录认证的原理"></a>登录认证的原理</h3><ol>
<li>如何使用Session和Token（JWT）分别完成登录认证功能      —–  如何保存登录状态</li>
<li>如何使用过滤器(Filter) 和拦截器(Interceptor)分别完成对登录认证的统一处理   —– 如何检测登录状态</li>
<li>如何让”当前用户”全局可用(如何实现<strong>上下文</strong>对象)    —— 如何使用登录状态</li>
</ol>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>登录认证(Authentication)的概念非常简单，就是通过一定的手段对用户的身份进行确认</p>
<p>在Web系统中，有一个重要概念就是： HTTP请求是一个<strong>无状态</strong>的协议。也就是说浏览器每一次发送的请求都是独立的，对于服务器来说你每次的请求都是**”新客”**，它不记得你曾经有没有来过</p>
<p>因为服务器没有记忆，所以已经完成登录校验的用户，在下次请求中，服务器是无法认定其是否已经完成登录的。</p>
<p>那怎样才能让服务器记住你的登录状态呢？那就是**”凭证”<strong>,登录之后每一次请求都携带一个登录凭证来告诉服务器我是谁，这样才能</strong>“有记忆”**</p>
<h4 id="如何颁发凭证给客户端"><a href="#如何颁发凭证给客户端" class="headerlink" title="如何颁发凭证给客户端"></a>如何颁发凭证给客户端</h4><p>现在流行的两种方式就是： <strong>Session和JWT</strong>， 无论是哪种方式其原理都是 Token机制，即保存凭证:</p>
<ol>
<li>前端发起登录认证请求</li>
<li>后端登录验证通过，返回给前端一个<strong>凭证</strong></li>
<li>前端发起新的请求时携带这个凭证</li>
</ol>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="Session模式"><a href="#Session模式" class="headerlink" title="Session模式"></a>Session模式</h4><p>Session，是一种<strong>有状态的会话管理机制</strong>，其目的就是为了解决HTTP无状态请求带来的问题</p>
<p>当用户登录认证请求通过时，服务器端会将用户的信息保存起来，并生成一个SESSIONID发送给前端，前端将这个SESSION ID保存起来（一般是存在cookie中）。 之后前端再发送请求时都携带SESSION ID，服务器再根据这个SESSION ID 来检查该用户有没有登录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.softeem.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.softeem.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.softeem.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(User user, HttpSession session)</span></span>&#123;</span><br><span class="line">        User currentUser=</span><br><span class="line">                userMapper.findUserByUsernameAndPassword(user.getUsername(),user.getPassword());</span><br><span class="line">        <span class="keyword">if</span>(currentUser != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 校验通过， 颁发凭证给客户端</span></span><br><span class="line">            <span class="comment">// 保存用户的登录状态到session中</span></span><br><span class="line">            <span class="comment">// session中如何颁发凭证</span></span><br><span class="line">            <span class="comment">// session会自动向客户端颁发一个sessionID到cookie中</span></span><br><span class="line">            <span class="comment">// 客户端会携带cookie请求服务器端</span></span><br><span class="line">            session.setAttribute(<span class="string">&quot;currentUser&quot;</span>,currentUser);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;用户名或密码错误&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">api1</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//        // 当我们获取session的时候，servlet会根据当前客户端发送的sessionID来决定该会话属于谁</span></span><br><span class="line"><span class="comment">//        User currentUser = (User) session.getAttribute(&quot;currentUser&quot;);</span></span><br><span class="line"><span class="comment">//        if(currentUser==null)&#123;</span></span><br><span class="line"><span class="comment">//            //  如果currentUser 等于null  说明sessionID（凭证）校验没有通过</span></span><br><span class="line"><span class="comment">//            return &quot;请先登录&quot;;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;成功返回数据API&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们编写过滤器是为了让每个API都能专注自身业务，而不去关注用户状态</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">api2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String username = userService.getName();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;成功返回数据API2 username: &quot;</span>+username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api3&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">api3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;成功返回数据API3&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h5 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h5><p>完成了基本的登录认证后，我们再加强一下功能！除了登录接口外，我们其他接口都要再controller层做登录判断，这太麻烦了。我们完全可以对每个接口过滤拦截一下，判断有没有登录，如果没有登录就直接结束请求，登录了才可以放行。这里我们使用过滤器来实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.softeem.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 登录请求不做判断，直接放行</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;/login&quot;</span>.equalsIgnoreCase(request.getRequestURI()))&#123;</span><br><span class="line">            chain.doFilter(request,response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        User user = (User) session.getAttribute(<span class="string">&quot;currentUser&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(user !=<span class="keyword">null</span>)&#123;</span><br><span class="line">            chain.doFilter(request,response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        PrintWriter writer = response.getWriter();</span><br><span class="line">        writer.write(<span class="string">&quot;请先登录&quot;</span>);</span><br><span class="line">        writer.flush();</span><br><span class="line">        writer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h5 id="上下文对象"><a href="#上下文对象" class="headerlink" title="上下文对象"></a>上下文对象</h5><p>在有些情况下，就算加了过滤器我们还是不能在controller层将session代码去掉，因为在实际业务中，对当前用户对象的操作是很常见的，而我们的业务代码一般都是写在service层，那么service层想要获取用户对象就只能通过controller传递</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.softeem.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求上下文类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前的请求对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpServletRequest <span class="title">getCurrentRequest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((ServletRequestAttributes)(RequestContextHolder.currentRequestAttributes()))</span><br><span class="line">                .getRequest();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过request获取当前用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">getCurrentUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (User) getCurrentRequest().getSession().getAttribute(<span class="string">&quot;currentUser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="JWT模式"><a href="#JWT模式" class="headerlink" title="JWT模式"></a>JWT模式</h4><p>除了Session之外，目前比较流行的做法就是使用JWT（JSON WEB TOKEN）。 关于JWT网上有很多的讲解资料，对于我们来说，我们知道如何使用其进行认证即可，无需过多去深入了解。大家只需要知道这两点就行：</p>
<ol>
<li>可以将一段数据加密成一段字符，也可以从这串字符解密回数据</li>
<li>可以对这个字符串(JWT Token)进行校验,比如有没有过期，有没有被篡改</li>
</ol>
<p>有上面这两个特性就足以让我们实现登录认证了。 当用户登录的时候，服务器生成一个JWT字符串发送给客户端浏览器，浏览器将JWT保存起来，在之后的请求中都携带上JWT，服务器在对该JWT进行校验，校验通过的话就代表该用户登录成功</p>
<h5 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h5><p>要使用JWT需要先引入一个依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.softeem.context.UserContext;</span><br><span class="line"><span class="keyword">import</span> com.softeem.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.softeem.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.softeem.util.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        User currentUser = userService.login(user);</span><br><span class="line">        <span class="keyword">if</span>(currentUser!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 登录成功   颁发凭证</span></span><br><span class="line">            <span class="comment">// Session是自动颁发凭证， JWT需要我们自己手动创建</span></span><br><span class="line">            String token = JwtUtil.generator(currentUser.getUsername());</span><br><span class="line">            <span class="comment">// 存入上下文</span></span><br><span class="line">            UserContext.add(currentUser);</span><br><span class="line">            <span class="keyword">return</span> token;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//登录失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;账号或密码错误&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;api1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">api1</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//        // 解析请求中携带的token</span></span><br><span class="line"><span class="comment">//        // 假设客户端默认把凭证(token) 放在请求头中,key 为 Authorization</span></span><br><span class="line"><span class="comment">//        String  jwtToken = request.getHeader(&quot;Authorization&quot;);</span></span><br><span class="line"><span class="comment">//        if(JwtUtil.parse(jwtToken)==null)&#123;</span></span><br><span class="line"><span class="comment">//            return &quot;请先登录&quot;;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;api成功返回数据,username:  &quot;</span>+userService.getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h5><p>和之前一样，如果每个接口都要手动判断一下用户有没有登录太麻烦了，所以我们需要统一处理，这里使用拦截器来实现功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.softeem.util.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 前置拦截方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 登录请求不需要校验凭证</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;/login&quot;</span>.equalsIgnoreCase(request.getRequestURI()))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从请求头取出token 并解析token</span></span><br><span class="line">        String token = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        Claims claims = JwtUtil.parse(token);</span><br><span class="line">        <span class="keyword">if</span>(claims!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        PrintWriter writer = response.getWriter();</span><br><span class="line">        writer.write(<span class="string">&quot;请先登录&quot;</span>);</span><br><span class="line">        writer.flush();</span><br><span class="line">        writer.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要注意的是，拦截器在使用后要记得注册一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.softeem.interceptor.LoginInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * web mvc 配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">WebMvcConfigurer <span class="title">createMvcConfigurer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">                registry.addInterceptor(<span class="keyword">new</span> LoginInterceptor());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="上下文"><a href="#上下文" class="headerlink" title="上下文"></a>上下文</h5><p>统一拦截做好后，接下来就是上下文对象，JWT不像Session把用户信息存储起来，所以JWT上下文要靠我们自己来实现。这里我们用到ThreadLocal防止线程冲突</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.softeem.entity.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserContext</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ThreadLocal</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 防止线程冲突，在线程作用域内的每个类中都可以进行共享</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;User&gt; userThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        userThreadLocal.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>&#123;</span><br><span class="line">        userThreadLocal.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">getCurrentUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userThreadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="Session和JWT的优劣"><a href="#Session和JWT的优劣" class="headerlink" title="Session和JWT的优劣"></a>Session和JWT的优劣</h4><p>两种方式都可以实现登录认证，那么在实际开发中到底使用哪一种估计是大家更加关心的问题。</p>
<p>在这里总结一下两者各自的优劣，至于具体选型就根据自己实际业务需求来了</p>
<h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><p>Session：</p>
<ul>
<li>开箱即用，简单方便</li>
<li>能够有效管理用户登录的状态：续期，销毁等(续期就是演唱用户登录状态的时间，销毁就是清除用户状态，比如退出操作)</li>
</ul>
<p>JWT：</p>
<ul>
<li>可以直接解析出数据，服务器端无需存储任何数据</li>
<li>天然地易于水平扩展(A,B,C三个系统，同一个Token都可以实现登录认证【单点登录】)</li>
</ul>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><p>Session：</p>
<ul>
<li>较JWT而言，需要额外存储数据，消耗更多的系统资源 （有状态，且保存在服务器端）</li>
<li>在分布式系统中，要考虑Session的一致性问题，提高系统的复杂度</li>
</ul>
<p>JWT:</p>
<ul>
<li>JWT签名长度远比一个Session ID长的多，增加了额外的网络开销</li>
<li>无法销毁，续期登录状态</li>
<li>密钥一旦泄露，攻击者可以肆无忌惮的操作我们的系统****</li>
</ul>
<p><strong>软件开发没有银弹，技术选型根据自己业务需要来就好了，千万必要单一崇拜某一技术而排斥其他技术</strong></p>
<h3 id="使用框架"><a href="#使用框架" class="headerlink" title="使用框架"></a>使用框架</h3><p>Web系统中登录认证就是<strong>凭证机制</strong>无论是Session还是JWT，都是在用户登录成功时返回给用户一个凭证。后续用户访问该系统都会携带凭证来证明自己的身份。后端会对需要进行认证的接口进行安全判断，若凭证没有问题则代表已登录就放行接口，若有问题则直接拒绝请求。<strong>这个安全判断都是放在过滤器里统一处理的</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/1.jpg" alt="1.jpg"></p>
<p>SpringSecurity对web系统的支持就是基于这一个一个的过滤器链，用户的请求都会经过Servlet的过滤器链，在之前我们只是实现了一个用于认证凭证的过滤，而SpringSecurity也是做同样的事完成了更多的功能</p>
<p>在Servlet过滤器链中，Spring Security向其添加了一个FilterChainProxy的过滤器，这个代理过滤器会创建一套SpringSecurity的自定义过滤器链</p>
<p>FilterChainProxy源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FirewalledRequest fwRequest = <span class="keyword">this</span>.firewall.getFirewalledRequest((HttpServletRequest)request);</span><br><span class="line">       HttpServletResponse fwResponse = <span class="keyword">this</span>.firewall.getFirewalledResponse((HttpServletResponse)response);</span><br><span class="line">       List&lt;Filter&gt; filters = <span class="keyword">this</span>.getFilters((HttpServletRequest)fwRequest);</span><br></pre></td></tr></table></figure>

<p>通过观察，我们可以看到SpringSecurity默认一共会启动15个过滤器，这些过滤器各自都会完成各自的功能，有一些过滤器无需我们进行自定义，但是一些关键的过滤器，我们还是要根据自身的业务来自定义的。</p>
<p>UsernamePasswordAuthenticationFilter :  负责登录认证</p>
<p>FilterSecurityInterceptor: 负责权限授权</p>
<p>SpringSecurity的核心逻辑全在这一套过滤器中，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了SpringSecurity!  这个<strong>框架的使用方式就是对这些过滤器和组件进行扩展</strong></p>
<p>上面这段话一定要记住，带着这句话去理解SpringSecurity，你会站在高处俯瞰，整个框架的脉络就一目了然</p>
<p>刚才总览了一下全局，接着我们就要开始进行代码的实现了</p>
<p>要使用Spring Security首先要引入依赖包，这个大家可以在SpringBoot项目构建器中勾选Spring Security模块，也可以自己在pom中导入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>依赖导入后，SpringSecurity就默认提供了很多功能将程序保护起来了</p>
<p>在实际开发中，这些默认配置的功能往往不符合我们的实际需求，所以我们一般会自定义一些配置。配置很简单，新建一个配置类即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.configure(auth);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Security过滤器配置中心</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http 过滤器注册对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// CSRF这个过滤器不需要</span></span><br><span class="line">        http.csrf().disable();  <span class="comment">//禁用csrf 过滤器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="最简单的认证方式"><a href="#最简单的认证方式" class="headerlink" title="最简单的认证方式"></a>最简单的认证方式</h4><p>不管使用那种方式认证和框架，有些核心概念是不会变的，这些核心概念在安全框架中也会使用各种组件来实现，了解各种组件的使用顺便也实现了功能</p>
<p>我们的系统中会有很多用户，确认当前是哪个用户正在使用我们系统就是登录认证的核心了。这里我们提取出一个核心概念:  <strong>当前登录用户/当前认证用户</strong> . 整个系统的安全都是围绕着当前用户展开的！ 这个不难理解，每个业务功能都要确认当前是谁在使用。这一概念在Security中的体现就是 <strong>Authentication</strong> 接口， 它存储了认证信息，代表当前用户</p>
<p>我们在程序中如何获取并使用它呢？ 我们需要通过<strong>SecurityContext</strong>来获取Authentication， 通过昨天的学习，大家应该能猜到SecurityContext就是我们的<strong>上下文对象</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这种在一个线程中横跨若干方法调用，需要传递的对象我们一般称为上下文（Context）。 上下文对象是非常有必要的，否则你的每个方法都得额外增加一个参数接收对象，太麻烦了</span><br></pre></td></tr></table></figure>



<p>这个上下文对象是通过SecurityContextHolder来管理的，你可以在任何地方获取它</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SecurityContext context = SecurityContextHolder.getContext();  <span class="comment">// 获取上下文</span></span><br><span class="line">Authentication authentication = context.getAuthentication();  <span class="comment">// 获取当前用户</span></span><br></pre></td></tr></table></figure>

<p>它的原理也非常简单，就和我们在JWT项目中设计的上下文对象一样，也是使用ThreadLocal来保证一个线程传递一个对象</p>
<p>现在我们已经知道了SpringSecurity中三个核心对象</p>
<p>Authentication:  存储了认证信息，代表当前登录的用户</p>
<p>SecurityContext: 上下文对象，用来获取Authentication</p>
<p>SecurityContextHolder： 上下文管理对象用于在任何地方获取SecurityContext</p>
<p><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/2.jpg" alt="2.jpg"></p>
<p>Principal:  用户信息，没有认证的时候是用户名，认证了是用户对象</p>
<p>Credentials： 用户凭证，一般是密码</p>
<p>Authorities：  用户权限</p>
<p>Security的认证流程：<strong>将认证信息存入安全上下文即代表用户已经登录</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">      <span class="comment">// 安全上下文中有 Authentication对象 即表示通过认证</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="string">&quot;admin&quot;</span>.equalsIgnoreCase(user.getUsername())&amp;&amp;<span class="string">&quot;123&quot;</span>.equalsIgnoreCase(user.getPassword()))&#123;</span><br><span class="line">          <span class="comment">// 登录成功</span></span><br><span class="line">          <span class="comment">// authentication： 当前已经完成认证的用户信息</span></span><br><span class="line">          Authentication authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(user.getUsername()</span><br><span class="line">          ,user.getPassword(), Collections.emptyList());</span><br><span class="line">          <span class="comment">//存入安全上下文  使用session模式 在客户端写入SessionID到cookie中</span></span><br><span class="line">          <span class="comment">// authentication对象的 authenticated属性为true则代表已经完成认证</span></span><br><span class="line">          SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&quot;登录失败&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>和不使用框架时的流程一样， 在存入安全上下文后，同样会将sessionid发送给客户端保存在cookie中，随后客户端会携带cookie中的sessionID访问后端，SessionID校验通过则认证成功</p>
<p>当前查询用户信息并校验账户密码是完全由我们自己在业务层编写所有逻辑实现的，其实这一块Security也提供了组件供我们使用的</p>
<h4 id="AuthenticationManager-认证方式"><a href="#AuthenticationManager-认证方式" class="headerlink" title="AuthenticationManager 认证方式"></a>AuthenticationManager 认证方式</h4><p>AuthenticationManager就是SpringSecurity用于执行身份验证的组件，只需要调用它的authenticate方法即可完成认证、SpringSecurity默认的认证方法就是在UsernamePasswordAuthenticationFilter这个过滤器中调用这个组件，该过滤器负责认证逻辑</p>
<p>想要使用该组件需要先配置一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span>  <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationManager <span class="title">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf().disable();</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在使用的时候只需要在controller中装配AuthenticationManager，并调用authenticate方法即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 校验流程</span></span><br><span class="line">    Authentication authentication = authenticationManager.authenticate(<span class="keyword">new</span> UsernamePasswordAuthenticationToken(user.getUsername(),user.getPassword()));</span><br><span class="line">    <span class="keyword">if</span>(authentication!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;登录失败&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点就在这个方法   authenticationManager.authenticate</p>
<p>authenticate方法的源码大致如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationManagerxxxx</span> <span class="keyword">implements</span> <span class="title">AuthenticationManager</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication token)</span></span>&#123;</span><br><span class="line">    <span class="comment">// token:  传递过来的输入对象，代表当前用户输入的用户名和密码</span></span><br><span class="line">    String username = token.getName();</span><br><span class="line">    <span class="comment">// 调用UserDetailsService提供的loadByusername方法</span></span><br><span class="line">    UserDetails userDetails = userDetailsService.loadByUsername(username);</span><br><span class="line">    <span class="comment">// userDetails: 代表用户的详细信息，该对象从数据库加载而来</span></span><br><span class="line">    <span class="comment">// UserDetails中的密码通常是加密过后的密码 （密文）</span></span><br><span class="line">    String password = token.getPassword();  <span class="comment">// 接收输入密码（明文）</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!passwordEncoder.matches(password,userDetails.getPassword()))&#123;</span><br><span class="line">      <span class="function">thorw new <span class="title">BadCredentialsException</span><span class="params">()</span></span>; <span class="comment">//密码错误</span></span><br><span class="line">    &#125;</span><br><span class="line">    UsernamePasswordAuthenticationToken </span><br><span class="line">      token = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userDetails.getPrincipal(),<span class="keyword">null</span>,userDetails.getAuthorites());</span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="认证异常处理器-AuthenticationEntryPoint"><a href="#认证异常处理器-AuthenticationEntryPoint" class="headerlink" title="认证异常处理器 AuthenticationEntryPoint"></a>认证异常处理器 AuthenticationEntryPoint</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这个接口只有一个方法</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest var1, HttpServletResponse var2, AuthenticationException var3)</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们自定义一个EntryPoint类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEntryPoint</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException ex)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        PrintWriter writer = response.getWriter();</span><br><span class="line">        writer.write(<span class="string">&quot;认证错误&quot;</span>);</span><br><span class="line">        writer.flush();</span><br><span class="line">        writer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>在SecurityConfig中配置一下即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softeem.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEntryPoint</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException ex)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        PrintWriter writer = response.getWriter();</span><br><span class="line">        writer.write(<span class="string">&quot;认证错误&quot;</span>);</span><br><span class="line">        writer.flush();</span><br><span class="line">        writer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="JWT集成"><a href="#JWT集成" class="headerlink" title="JWT集成"></a>JWT集成</h3><p>关于JWT的介绍和工具我们在之前已经学习过了，这里就不多说了。这里直接带大家实现代码</p>
<p>采用JWT的方式进行认证首先第一步我们就可以在配置中禁用掉session</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  禁用Security的session模式，意味着存入安全上下文不在向客户端发送cookie</span></span><br><span class="line">http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">注意， 这里禁用的是SpringSecurity中的session机制，不代表整个系统不可以使用Session</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们在修改一下登录接口，当用户登录成功的同时，我们需要生成Token返回给前端，这样前端才能在后续请求中携带token</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> UserVo <span class="title">login</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        User currentUser = userMapper.findUserByUsername(user.getUsername());</span><br><span class="line">        <span class="keyword">if</span>(currentUser==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">&quot;用户名未找到&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!passwordEncoder.matches(user.getPassword(),currentUser.getPassword()))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 生成JWT令牌</span></span><br><span class="line">        String token = JwtUtil.generator(currentUser.getUsername());</span><br><span class="line">        <span class="keyword">if</span>(token!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            Authentication authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(currentUser.getUsername(),<span class="keyword">null</span>, Collections.emptyList());</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        &#125;</span><br><span class="line">        UserVo userVo = <span class="keyword">new</span> UserVo();</span><br><span class="line">        userVo.setUsername(currentUser.getUsername());</span><br><span class="line">        userVo.setToken(token);</span><br><span class="line">        <span class="keyword">return</span> userVo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>每当一个请求到来我们偶的都会校验JWT是否正确，如果正确我们要确保上下文中存在Authentication对象，如果不存在后续的过滤器会认为没有通过认证而拒绝客户端的访问</p>
<p>我们自定义一个过滤器来实现JWT的校验功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(request.getMethod().equalsIgnoreCase(<span class="string">&quot;OPTIONS&quot;</span>))&#123;</span><br><span class="line">            chain.doFilter(request,response);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(request.getRequestURI().equalsIgnoreCase(<span class="string">&quot;/login&quot;</span>))&#123;</span><br><span class="line">            chain.doFilter(request,response);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析请求中包含的token信息</span></span><br><span class="line">        String token = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        Claims claims = JwtUtil.parse(token);</span><br><span class="line">        <span class="keyword">if</span>(claims!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            String username = claims.getSubject();</span><br><span class="line">            User currentUser = userMapper.findUserByUsername(username);</span><br><span class="line">            <span class="keyword">if</span>(SecurityContextHolder.getContext().getAuthentication()==<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">// 手动组装一个认证对象，存入上下文中即可</span></span><br><span class="line">                Authentication authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(currentUser.getUsername(),<span class="keyword">null</span>, Collections.emptyList());</span><br><span class="line">                SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>授权也是整个系统中非常重要的一个环节，我们的系统往往有多个用户，且每个用户都拥有不同的权限，不同的权限代表着其有不同的操作内容。  如何实现根据权限来对用户进行访问控制，这是权限系统中必不可少的环节</p>
<p>先谈如何设计，在考虑如何实现</p>
<p>RBAC:  基于角色的访问控制</p>
<p>用户和权限之间显然是一种多对多的关系，但是用户和权限如果直接关联不是一种好的设计</p>
<p>使用Redis刷新Jwt凭证</p>
<p>大家现在都使用手机微信，手机QQ，会发现在登录成功后，很少让我们再去登录的，基本上只要保证网络畅通，登录会很长时间的保存状态。那么这是为什么呢？ 通过我们的学习我们知道认证有两种方式，基于Session的是有状态的，服务器的状态一旦发生变化就会影响到session，所以例如WX或者QQ肯定不是Session模式，但是如果他们使用的是JWT模式，JWT总会有过期时间，而且官方是建议我们将过期时间尽量缩短来保证jwt安全的。</p>
<p>为了保证账号安全，JWT不可能长时间不更新</p>
<p>为了保证用户体验，不可能让用户反复去登录</p>
<p>如何实现，JWT即可以安全的在短时间内重新创建颁发给客户端，又可以免去登录</p>
<h4 id="无感知刷新令牌"><a href="#无感知刷新令牌" class="headerlink" title="无感知刷新令牌"></a>无感知刷新令牌</h4><p>最常见的实现方式是借助Redis来帮助我们刷新令牌</p>
<p>思路：</p>
<p>Redis是一种Key-Value的Hash存储结构，是一种内存数据库技术， 我们在创建Token令牌后，使用用户名为key，token为值存入Redis并设置有效时间(Redis中存储的有效时间), JWT令牌则设置一个较短的有效时间。</p>
<p>比如 jwt的时间是2小时，而Redis的有效时间是12小时，那么在Jwt过期后，如果Redis还没有过期，则重新颁发新的凭证给客户端，同时将Redis中存储的Token覆盖掉刷新Redis的时间</p>
<h2 id="Security刷新Token"><a href="#Security刷新Token" class="headerlink" title="Security刷新Token"></a>Security刷新Token</h2><p>在项目中引入Redis的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml中对redis进行配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis数据库索引（默认为0）</span></span><br><span class="line"><span class="string">spring.redis.database=0</span> </span><br><span class="line"><span class="comment"># Redis服务器地址</span></span><br><span class="line"><span class="string">spring.redis.host=localhost</span></span><br><span class="line"><span class="comment"># Redis服务器连接端口</span></span><br><span class="line"><span class="string">spring.redis.port=6379</span> </span><br><span class="line"><span class="comment"># Redis服务器连接密码（默认为空）</span></span><br><span class="line"><span class="string">spring.redis.password=</span></span><br><span class="line"><span class="comment">#连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line"><span class="string">spring.redis.jedis.pool.max-active=8</span></span><br><span class="line"><span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class="line"><span class="string">spring.redis.jedis.pool.max-wait=-1</span></span><br><span class="line"><span class="comment"># 连接池中的最大空闲连接</span></span><br><span class="line"><span class="string">spring.redis.jedis.pool.max-idle=8</span></span><br><span class="line"><span class="comment"># 连接池中的最小空闲连接</span></span><br><span class="line"><span class="string">spring.redis.jedis.pool.min-idle=0</span></span><br><span class="line"><span class="comment"># 连接超时时间（毫秒）</span></span><br><span class="line"><span class="string">spring.redis.timeout=300</span></span><br></pre></td></tr></table></figure>

<p>由于Springboot中一般使用RedisTemplate提供的方法来操作Redis，所以需要配置RedisTemplate，在utils包中新建一个配置类RedisConfig。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span> <span class="comment">//开启注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * retemplate相关配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> factory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="comment">// 配置连接工厂</span></span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用Jackson2JsonRedisSerializer来序列化和反序列化redis的value值（默认使用JDK的序列化方式）</span></span><br><span class="line">        Jackson2JsonRedisSerializer jacksonSeial = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line"></span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        <span class="comment">// 指定要序列化的域，field,get和set,以及修饰符范围，ANY是都有包括private和public</span></span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        <span class="comment">// 指定序列化输入的类型，类必须是非final修饰的，final修饰的类，比如String,Integer等会跑出异常</span></span><br><span class="line">        om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance,ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jacksonSeial.setObjectMapper(om);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 值采用json序列化</span></span><br><span class="line">        template.setValueSerializer(jacksonSeial);</span><br><span class="line">        <span class="comment">//使用StringRedisSerializer来序列化和反序列化redis的key值</span></span><br><span class="line">        template.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置hash key 和value序列化模式</span></span><br><span class="line">        template.setHashKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        template.setHashValueSerializer(jacksonSeial);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分的代码主要作用就是配置序列化器，这里配置的是用jackson来序列化redis中value的值，使redis可以支持json格式数据的存储和读取。</p>
<p>然后在utils包中新建一个redis的工具类RedisUtil。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisUtil</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisUtil</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//============================String=============================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存获取</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key==<span class="keyword">null</span>?<span class="keyword">null</span>:redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存放入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key,Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存放入并设置时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 时间(秒) time要大于0 如果time小于等于0 将设置无限期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false 失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key,Object value,<span class="keyword">long</span> time)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(time&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                set(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们目前只写了3个方法，其中set方法也主要使用设定时间的。</p>
<p>之后修改UserController中的登录方法，在生成token之后将username和token以键值对保存到redis中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String token = JWTUtil.genToken(map, <span class="keyword">new</span> Date(System.currentTimeMillis() + <span class="number">60L</span>* <span class="number">1000L</span> * <span class="number">30L</span>));</span><br><span class="line">redisUtil.set(username, token, <span class="number">60</span> * <span class="number">60</span> * <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>最后在TokenInterceptor中添加token过期后刷新的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (request.getMethod().equals(<span class="string">&quot;OPTIONS&quot;</span>))&#123;</span><br><span class="line">            response.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        String token = request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        String responseData = <span class="string">&quot;&#123;\&quot;code\&quot;:401,\&quot;message\&quot;:\&quot;Unauthorized\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">//token不存在</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != token) &#123;</span><br><span class="line">            Map&lt;String, String&gt; login = JWTUtil.verifyToken(token);</span><br><span class="line">            String username = request.getHeader(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            <span class="comment">//解密token后的loginId与用户传来的loginId不一致，一般都是token过期</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> != username &amp;&amp; <span class="keyword">null</span> != login) &#123;</span><br><span class="line">                <span class="keyword">if</span>(username.equals(login.get(<span class="string">&quot;username&quot;</span>))) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">// 刷新token逻辑 start</span></span><br><span class="line">                    String redisCache = (String) redisUtil.get(username);</span><br><span class="line">                    <span class="keyword">if</span>(token.equals(redisCache))&#123;</span><br><span class="line">                        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">                        map.put(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">                        String newToken = JWTUtil.genToken(map, <span class="keyword">new</span> Date(System.currentTimeMillis() + <span class="number">60L</span>* <span class="number">1000L</span> * <span class="number">30L</span>));</span><br><span class="line">                        redisUtil.set(username, newToken, <span class="number">60</span> * <span class="number">60</span> * <span class="number">2</span>);</span><br><span class="line">                        responseData = <span class="string">&quot;&#123;\&quot;code\&quot;:100,\&quot;message\&quot;:\&quot;Token expired, a new token generated.\&quot;,\&quot;token\&quot;:\&quot;&quot;</span> + newToken + <span class="string">&quot;\&quot;&#125;&quot;</span>;</span><br><span class="line">                        System.out.println(responseData);</span><br><span class="line">                        responseMessage(response, response.getWriter(), responseData);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 刷新token逻辑 end</span></span><br><span class="line">                    responseMessage(response, response.getWriter(), responseData);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                responseMessage(response, response.getWriter(), responseData);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            responseMessage(response, response.getWriter(), responseData);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这样如果在30分钟后2小时以内token过期，则可以在redis中找到缓存的username对应的token，允许刷新token，返回给前端，前端接收到新的token后替换，重新发送请求。这样只要用户两次操作间隔时间不超过2小时，便不用重新登录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> R <span class="title">list</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





















</div><div class="article-licensing box"><div class="licensing-title"><p>Spring Security</p><p><a href="https://guosjj.github.io/笔记/spring/Spring Security.html">https://guosjj.github.io/笔记/spring/Spring Security.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://guosjj.github.io"><p>Guosj</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-06-25</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-06-25</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/zfb.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/wx.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/%E7%AC%94%E8%AE%B0/docker/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html"><span class="level-item">docker常用命令</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '6c46578cda1de10de1eeb86946b6f2d6',
            repo: 'blog_comment',
            owner: 'guosjj',
            clientID: '5cf593a6a13262f47886',
            clientSecret: 'bea29594721773a8ea004989f322a544c5deb24c',
            admin: ["guosjj"],
            createIssueManually: true,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: 'last',
            
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#Spring-Security"><span>Spring Security</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#登录认证的原理"><span>登录认证的原理</span></a></li><li><a class="is-flex is-mobile" href="#基础知识"><span>基础知识</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#如何颁发凭证给客户端"><span>如何颁发凭证给客户端</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#实现"><span>实现</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#上下文对象"><span>上下文对象</span></a></li><li><a class="is-flex is-mobile" href="#上下文"><span>上下文</span></a></li><li><a class="is-flex is-mobile" href="#缺点"><span>缺点</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#使用框架"><span>使用框架</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#最简单的认证方式"><span>最简单的认证方式</span></a></li><li><a class="is-flex is-mobile" href="#AuthenticationManager-认证方式"><span>AuthenticationManager 认证方式</span></a></li><li><a class="is-flex is-mobile" href="#认证异常处理器-AuthenticationEntryPoint"><span>认证异常处理器 AuthenticationEntryPoint</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#JWT集成"><span>JWT集成</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#授权"><span>授权</span></a><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex is-mobile" href="#无感知刷新令牌"><span>无感知刷新令牌</span></a></li></ul></ul></li><li><a class="is-flex is-mobile" href="#Security刷新Token"><span>Security刷新Token</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/1.png" alt="standP"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">standP</p><p class="is-size-6 is-block">永远保存一颗学徒的心</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>提瓦特</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">7</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/guosjj" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/guosjj"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="QQ" href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=2547361543"><i class="fab fa-qq"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:2547361543@qq.com"><i class="fa fa-envelope"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/%E7%AC%94%E8%AE%B0/spring/Spring%20Security.html"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/youlingsha.png" alt="Spring Security"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-06-25T07:52:33.000Z">2022-06-25</time></p><p class="title"><a href="/%E7%AC%94%E8%AE%B0/spring/Spring%20Security.html">Spring Security</a></p><p class="categories"><a href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a> / <a href="/categories/%E7%AC%94%E8%AE%B0/Spring-Security/">Spring Security</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/%E7%AC%94%E8%AE%B0/docker/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/123.png" alt="docker常用命令"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-06-19T13:57:56.000Z">2022-06-19</time></p><p class="title"><a href="/%E7%AC%94%E8%AE%B0/docker/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html">docker常用命令</a></p><p class="categories"><a href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a> / <a href="/categories/%E7%AC%94%E8%AE%B0/docker/">docker</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/%E7%AC%94%E8%AE%B0/redis/redis%E4%BA%8B%E5%8A%A1.html"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/QQ图片20200608213116.png" alt="redis事务"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-06-14T13:14:56.000Z">2022-06-14</time></p><p class="title"><a href="/%E7%AC%94%E8%AE%B0/redis/redis%E4%BA%8B%E5%8A%A1.html">redis事务</a></p><p class="categories"><a href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a> / <a href="/categories/%E7%AC%94%E8%AE%B0/redis/">redis</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/%E7%AC%94%E8%AE%B0/linux/Linux%E6%95%99%E7%A8%8B%E7%AC%94%E8%AE%B0.html"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/sqks.jpg" alt="Linux教程笔记"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-06-14T11:26:56.000Z">2022-06-14</time></p><p class="title"><a href="/%E7%AC%94%E8%AE%B0/linux/Linux%E6%95%99%E7%A8%8B%E7%AC%94%E8%AE%B0.html">Linux教程笔记</a></p><p class="categories"><a href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a> / <a href="/categories/%E7%AC%94%E8%AE%B0/linux/">linux</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/java/java%E7%B1%BB%E9%97%B46%E5%A4%A7%E5%85%B3%E7%B3%BB.html"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/0638202b7ws2d2w4bzsyuu.jpg" alt="java类间六大关系"></a></figure><div class="media-content"><p class="date"><time dateTime="2022-06-13T12:15:56.000Z">2022-06-13</time></p><p class="title"><a href="/java/java%E7%B1%BB%E9%97%B46%E5%A4%A7%E5%85%B3%E7%B3%BB.html">java类间六大关系</a></p><p class="categories"><a href="/categories/java/">java</a> / <a href="/categories/java/java%E5%9F%BA%E7%A1%80/">java基础</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Plugins/"><span class="level-start"><span class="level-item">Plugins</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/Plugins/Comment/"><span class="level-start"><span class="level-item">Comment</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/java/"><span class="level-start"><span class="level-item">java</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/java/java%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">java基础</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">笔记</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/%E7%AC%94%E8%AE%B0/Spring-Security/"><span class="level-start"><span class="level-item">Spring Security</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%AC%94%E8%AE%B0/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%AC%94%E8%AE%B0/linux/"><span class="level-start"><span class="level-item">linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E7%AC%94%E8%AE%B0/redis/"><span class="level-start"><span class="level-item">redis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Getting-Started/"><span class="tag">Getting Started</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Icarus-User-Guide/"><span class="tag">Icarus User Guide</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Security/"><span class="tag">Spring Security</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.jsdelivr.net/gh/guosjj/blog_image/img/2022/logo.png" alt="standP" height="28"></a><p class="size-small"><span>&copy; 2022 Guosj</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">川ICP备88888888号-8（测试）</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
        }var now = new Date();setInterval("createTime('2022/06/11 00:00:00')", 250,"");</script><br></span><div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong> 小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="5232971309" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('5cf593a6a13262f47886','bea29594721773a8ea004989f322a544c5deb24c','guosjj','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(true){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('5cf593a6a13262f47886','bea29594721773a8ea004989f322a544c5deb24c','guosjj','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>